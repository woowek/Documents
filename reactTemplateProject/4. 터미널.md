> í„°ë¯¸ë„
---

- í„°ë¯¸ë„ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë ¤ë©´ ì „ìš© í„°ë¯¸ë„ ë°±ì•¤ë“œê°€ í•„ìš”í•œê°€ë³´ë‹¤..
- ì´ê±¸ API ë°±ì—”ë“œì™€ ê°™ì´êµ¬ì„±ì„ í•˜ê¸°ì—” ë¶€ì ì ˆí•˜ë‹¤ê³  í•œë‹¤.

- frontend
  - xterm.js
    - VS Codeì²˜ëŸ¼ ì§„ì§œ í„°ë¯¸ë„ UI ì œê³µ
    - ê·¸ëƒ¥ ì´ê±¸ ì“°ëœë‹¤..
    - ì„¤ì¹˜

        ```
        npm install @xterm/xterm @xterm/addon-fit @xterm/addon-web-links
        ```

    - ì—¬ê¸°ì„  vite.configì— ì„¤ì •í–ˆëŠ”ë° ìš´ì˜ì‹œì—” nginxì—ì„œ í• ë“¯
- backend
  - Node.js + Express + node-pty
    - ì•„ë§ˆ ì´ìª½ìœ¼ë¡œ í•´ì•¼í•˜ì§€ ì•Šì„ê¹Œ...

        ```
        npm install express ws node-pty
        ```

    - ì–´ì°¨í”¼ nodejsë¼ ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ ë ê±°ê°™ìŒ
    - ì‹¤í–‰

        ```
        node terminalServer.js
        ```

  - Wetty
    - ì„¤ì¹˜ í›„ ì‹¤í–‰

        ```
        npm install -g wetty
        wetty --port 8080
        ```

- ê³ ì°°
  - ì´ë ‡ê²Œ ë˜ë©´ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ê²½ìš°ì—” ì–´ë–»ê²Œ ì²˜ë¦¬í•´ì•¼í•˜ëŠ”ê°€..
  - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— ë°±ì•¤ë“œë¥¼ ì„¸íŒ…í•˜ëŠ” ë°©ë²•ì´ ê°€ëŠ¥í•˜ê¸°ëŠ” í•˜ì§€ë§Œ ê·¸ë ‡ê²Œ í•˜ì§„ ì•Šê³ 
  - ëŒ€ë¶€ë¶„ docker exec / kubectl exec ë¥¼ ì‚¬ìš©í•œë‹¤..
  - ë¬¼ë¡  ì‚¬ìš©í•˜ë ¤ë©´ ë°±ì•¤ë“œ ì†ŒìŠ¤ì˜ ìˆ˜ì •ì´ í•„ìš”í•˜ë‹¤.

- ì •ë¦¬
  - frontend
    - nodejs ë°±ì•¤ë“œì™€ì˜ ì›¹ì†Œì¼“ í†µì‹ 
    - xterm.jsë¥¼ ì´ìš©í•œ UI êµ¬ì„±
    - useRef
      - terminalRef : useRef<HTMLDivElement>
      - xtermRef : useRef<XTerm | null>
      - fitAddonRef : useRef<FitAddon | null>
      - socketRef : useRef<WebSocket | null>
    - useState
      - isConnected : useState
      - connectionError : useState<string | null>
    - useEffect
      1. XTerm ì´ˆê¸°í™”

        ```ts
        const term = new XTerm({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Consolas, "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
            },
            scrollback: 1000,
            convertEol: true,
        })
        ```

      2. ì• ë“œì˜¨ ì¶”ê°€

      ```ts
        const fitAddon = new FitAddon()
        term.loadAddon(fitAddon)
        term.loadAddon(new WebLinksAddon())
      ```

      3. í„°ë¯¸ë„ ì—´ê¸°

      ```ts
        term.open(terminalRef.current)
        xtermRef.current = term
        fitAddonRef.current = fitAddon
      ```

      4. WebSocket ì—°ê²°

      ```ts
        const initTimer = setTimeout(() => {
        fitAddon.fit()
        
        // WebSocket ì—°ê²°
        const socket = new WebSocket('ws://localhost:8080')
        socketRef.current = socket

        socket.onopen = () => {
            setIsConnected(true)
            setConnectionError(null)
            term.writeln('\x1b[32mâœ… í„°ë¯¸ë„ ì—°ê²° ì™„ë£Œ\x1b[0m\n')
            
            // í„°ë¯¸ë„ í¬ê¸° ì „ì†¡
            socket.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }))
        }

        socket.onerror = () => {
            setConnectionError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨')
            term.writeln('\x1b[31mâŒ ì—°ê²° ì‹¤íŒ¨\x1b[0m')
            term.writeln('í„°ë¯¸ë„ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”: node terminalServer.js\n')
        }

        socket.onclose = () => {
            setIsConnected(false)
            term.writeln('\n\x1b[31mğŸ”Œ ì„œë²„ ì—°ê²° ì¢…ë£Œ\x1b[0m')
        }

        // ë°ì´í„° ìˆ˜ì‹  â†’ í™”ë©´ ì¶œë ¥
        socket.onmessage = (event) => term.write(event.data)

        // í‚¤ë³´ë“œ ì…ë ¥ â†’ ì„œë²„ ì „ì†¡
        term.onData((data) => {
            if (socket.readyState === WebSocket.OPEN) {
            socket.send(data)
            }
        })

        // ì°½ í¬ê¸° ë³€ê²½ ì²˜ë¦¬
        const handleResize = () => {
            fitAddon.fit()
            if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }))
            }
        }
        window.addEventListener('resize', handleResize)

        cleanup = () => {
            window.removeEventListener('resize', handleResize)
            socket.close()
            term.dispose()
        }
        }, 100)
      ```

      - UI íŒŒíŠ¸
      ```ts
      <div className="terminal-status">
        {isConnected ? (
          <div className="status-indicator connected">
            <span className="status-dot"></span>
            <span>ì„œë²„ ì—°ê²°ë¨</span>
          </div>
        ) : connectionError ? (
          <div className="status-indicator error">
            <span className="status-dot"></span>
            <span>{connectionError}</span>
            <button onClick={handleReconnect} className="reconnect-btn">
              ğŸ”„ ì¬ì—°ê²°
            </button>
          </div>
        ) : (
          <div className="status-indicator connecting">
            <span className="status-dot"></span>
            <span>ì—°ê²° ì¤‘...</span>
          </div>
        )}
      </div>

      <div className="xterm-container">
        <div className="terminal-header">
          <div className="terminal-buttons">
            <span className="btn-close"></span>
            <span className="btn-minimize"></span>
            <span className="btn-maximize"></span>
          </div>
          <div className="terminal-title">xterm.js@websocket:~</div>
        </div>
        <div ref={terminalRef} className="xterm-terminal" />
      </div>
      ```

    - backend

- êµ¬ì„±
  - backend
    - ì—­ì‹œë‚˜ AIê°€ ì§œì¤¬ë‹¤..

        ```js
        import { WebSocketServer } from 'ws'
        import pty from 'node-pty'
        import os from 'os'

        const PORT = 8080

        // WebSocket ì„œë²„ ìƒì„±
        const wss = new WebSocketServer({ port: PORT })

        console.log(`ğŸš€ í„°ë¯¸ë„ ì„œë²„ ì‹œì‘: ws://localhost:${PORT}`)
        console.log(`ğŸ“‹ í”Œë«í¼: ${os.platform()}`)

        wss.on('connection', (ws) => {
        console.log('âœ… ìƒˆ í„°ë¯¸ë„ ì—°ê²°')

        // í”Œë«í¼ì— ë§ëŠ” shell ì„ íƒ
        const shell = os.platform() === 'win32' ? 'cmd.exe' : 'bash'
        const args = os.platform() === 'win32' ? ['/K', 'chcp 65001'] : []  // UTF-8 ì½”ë“œí˜ì´ì§€

        // PTY (ê°€ìƒ í„°ë¯¸ë„) ìƒì„±
        const ptyProcess = pty.spawn(shell, args, {
            name: 'xterm-256color',
            cols: 80,
            rows: 24,
            cwd: process.env.HOME || process.env.USERPROFILE || process.cwd(),
            env: {
            ...process.env,
            LANG: 'ko_KR.UTF-8',
            LC_ALL: 'ko_KR.UTF-8',
            TERM: 'xterm-256color',
            },
            encoding: 'utf8',
        })

        console.log(`ğŸ–¥ï¸  Shell í”„ë¡œì„¸ìŠ¤ ìƒì„±: ${shell} (PID: ${ptyProcess.pid})`)

        // Shell ì¶œë ¥ â†’ WebSocketìœ¼ë¡œ ì „ì†¡
        ptyProcess.onData((data) => {
            try {
            ws.send(data)
            } catch (err) {
            console.error('âŒ ì „ì†¡ ì˜¤ë¥˜:', err.message)
            }
        })

        // WebSocket ë©”ì‹œì§€ ì²˜ë¦¬
        ws.on('message', (msg) => {
            try {
            const message = msg.toString()
            
            // JSON í˜•ì‹ì¸ì§€ í™•ì¸ (ë¦¬ì‚¬ì´ì¦ˆ ëª…ë ¹ì–´)
            try {
                const data = JSON.parse(message)
                if (data.type === 'resize') {
                ptyProcess.resize(data.cols, data.rows)
                console.log(`ğŸ“ í„°ë¯¸ë„ í¬ê¸° ì¡°ì •: ${data.cols}x${data.rows}`)
                return
                }
            } catch {
                // JSON ì•„ë‹ˆë©´ ì¼ë°˜ ì…ë ¥ìœ¼ë¡œ ì²˜ë¦¬
            }
            
            // ì¼ë°˜ ì…ë ¥ â†’ Shellë¡œ ì „ë‹¬
            ptyProcess.write(message)
            } catch (err) {
            console.error('âŒ ì…ë ¥ ì˜¤ë¥˜:', err.message)
            }
        })

        // ì—°ê²° ì¢…ë£Œ
        ws.on('close', () => {
            console.log('ğŸ”Œ í„°ë¯¸ë„ ì—°ê²° ì¢…ë£Œ')
            try {
            ptyProcess.kill()
            } catch (err) {
            console.error('âŒ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì˜¤ë¥˜:', err.message)
            }
        })

        // ì—ëŸ¬ ì²˜ë¦¬
        ws.on('error', (err) => {
            console.error('âŒ WebSocket ì˜¤ë¥˜:', err.message)
        })

        ptyProcess.onExit((exitCode) => {
            console.log(`ğŸ›‘ Shell í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ì½”ë“œ: ${exitCode.exitCode})`)
            try {
            ws.close()
            } catch (err) {
            // ì´ë¯¸ ë‹«íŒ ê²½ìš° ë¬´ì‹œ
            }
        })
        })

        // ì„œë²„ ì—ëŸ¬ ì²˜ë¦¬
        wss.on('error', (err) => {
        console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', err.message)
        })

        // ì„œë²„ ì¢…ë£Œ ì‹œ ì •ë¦¬
        process.on('SIGINT', () => {
        console.log('\nğŸ›‘ ì„œë²„ ì¢…ë£Œ ì¤‘...')
        wss.close(() => {
            console.log('âœ… ì„œë²„ ì¢…ë£Œ ì™„ë£Œ')
            process.exit(0)
        })
        })
        ```

  - frontend
    - ì´ê±° ì—­ì‹œ AIê°€ ì§œì¤€ê±°ë‹¤...

```ts

```
