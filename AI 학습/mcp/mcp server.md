ì¶œì²˜ : https://wikidocs.net/289908



- ì•„í‚¤íƒì²˜
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì‚¬ìš©ì (You)   â”‚
â”‚    ì§ˆë¬¸ ì…ë ¥      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ (Python Script)   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. ì‚¬ìš©ì ì§ˆë¬¸ ë°›ê¸°           â”‚  â”‚
â”‚  â”‚  2. LLMì— ì§ˆë¬¸ ì „ë‹¬           â”‚  â”‚
â”‚  â”‚  3. LLMì´ ë„êµ¬ í˜¸ì¶œ ê²°ì •       â”‚  â”‚
â”‚  â”‚  4. MCP ì„œë²„ì— ë„êµ¬ ì‹¤í–‰ ìš”ì²­  â”‚  â”‚
â”‚  â”‚  5. ê²°ê³¼ë¥¼ LLMì— ë‹¤ì‹œ ì „ë‹¬     â”‚  â”‚
â”‚  â”‚  6. ìµœì¢… ë‹µë³€ ìƒì„±            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚
        â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ollama LLM   â”‚   â”‚  MCP ì„œë²„     â”‚
â”‚ (llama3.1ë“±) â”‚   â”‚ (your_server) â”‚
â”‚              â”‚   â”‚               â”‚
â”‚ localhost:   â”‚   â”‚ stdio í†µì‹     â”‚
â”‚ 11434        â”‚   â”‚               â”‚
â”‚              â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ - ìì—°ì–´ ì´í•´ â”‚   â”‚ â”‚ Tool 1   â”‚ â”‚
â”‚ - ë„êµ¬ ì„ íƒ   â”‚   â”‚ â”‚ Tool 2   â”‚ â”‚
â”‚ - ë‹µë³€ ìƒì„±   â”‚   â”‚ â”‚ Tool 3   â”‚ â”‚
â”‚              â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


- êµ¬ì„± ë°©ë²•
    * ë‚´ê°€ ì´ì „ì— n8nìœ¼ë¡œ êµ¬ì„±í–ˆì„ë•Œ ë­”ê°€ ëë˜ê±°ê°™ì•„ì„œ gptí•œí…Œ ë¬¼ì–´ë´¤ë‹¤.
    * LangFlow 
        - ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ LLM + ë„êµ¬ ì—°ê²°
        - ì›¹ UIì—ì„œ ë°”ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
        - MCPë¥¼ ì§ì ‘ ì§€ì›í•˜ì§„ ì•Šì§€ë§Œ, Custom Toolë¡œ ë˜í•‘ ê°€ëŠ¥
    * Flowise
        - n8n ìŠ¤íƒ€ì¼ì˜ í”Œë¡œìš° ë¹Œë”
        - LLM + Custom Tools ì—°ê²° ê°€ëŠ¥
        - Dockerë¡œ ë¹ ë¥¸ ì‹¤í–‰
    * Streamlit + OpenWebUI ìŠ¤íƒ€ì¼



- mcp vs fastmcp
1. MCP (ê³µì‹ SDK)
    - ì œê³µ: Anthropicì˜ ê³µì‹ Model Context Protocol SDK
    - ì €ìˆ˜ì¤€(low-level) API
    - ì™„ì „í•œ ì œì–´ ê°€ëŠ¥
    - ë³µì¡í•œ ì„¤ì • í•„ìš”
    - stdio, SSE ë“± ë‹¤ì–‘í•œ ì „ì†¡ ë°©ì‹ ì§€ì›
    ```py
    from mcp.server import Server
    from mcp.server.stdio import stdio_server

    app = Server("my-server")

    @app.list_tools()
    async def list_tools():
        return [Tool(...)]  # ìˆ˜ë™ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆ ì •ì˜

    @app.call_tool()
    async def call_tool(name, arguments):
        # ìˆ˜ë™ìœ¼ë¡œ ë¼ìš°íŒ… ì²˜ë¦¬
        if name == "add":
            return ...
    ```
2. FastMCP
    - ì œê³µ: ì»¤ë®¤ë‹ˆí‹°ê°€ ë§Œë“  ê³ ìˆ˜ì¤€(high-level) ë˜í¼
    - FastAPI ìŠ¤íƒ€ì¼ì˜ ê°„ë‹¨í•œ ë¬¸ë²•
    - ìë™ ìŠ¤í‚¤ë§ˆ ìƒì„± (íƒ€ì… íŒíŠ¸ì—ì„œ)
    - ì ì€ ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ì½”ë“œ
    - MCP SDK ìœ„ì— êµ¬ì¶•ë¨
    ```py
    from fastmcp import FastMCP

    mcp = FastMCP("my-server")

    @mcp.tool()
    def add(a: float, b: float) -> float:
        """ë‘ ìˆ˜ë¥¼ ë”í•©ë‹ˆë‹¤"""
        return a + b  # ìë™ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆ ìƒì„±!

    mcp.run()  # ê°„ë‹¨í•œ ì‹¤í–‰
    ```


- fastmcp 
    * ì„¤ì¹˜í•˜ê¸°
    ```sh
    # uvë¥¼ ì‚¬ìš©í•œ ì„¤ì¹˜ (ê¶Œì¥)
    uv pip install fastmcp

    # ë˜ëŠ” pipë¥¼ ì‚¬ìš©í•œ ì„¤ì¹˜
    pip install fastmcp
    ```
    * ê°„ë‹¨í•œ ì˜ˆì œ
    ```sh
    from fastmcp import FastMCP

    # 1. ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    mcp = FastMCP("My First FastMCP Server ğŸš€")

    # 2. @mcp.tool ë°ì½”ë ˆì´í„°ë¡œ í•¨ìˆ˜ë¥¼ 'ë„êµ¬'ë¡œ ë“±ë¡
    @mcp.tool
    def add(a: int, b: int) -> int:
        """ë‘ ìˆ«ìë¥¼ ë”í•©ë‹ˆë‹¤."""
        return a + b

    # 3. ì„œë²„ ì‹¤í–‰ (ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ ì‹¤í–‰ë  ë•Œë§Œ)
    if __name__ == "__main__":
    mcp.run()
    ```

    * ì‹¤í–‰
    ```
    fastmcp run server.py
    ```


    * í…ŒìŠ¤íŠ¸
        - claude desktop
        - cursor
        - MCP Inspector
            * ê°œë³„ í•¨ìˆ˜ í˜¸ì¶œìš©
        ```
        npx @modelcontextprotocol/inspector
        ```
        - ì§ì ‘ Python ìŠ¤í¬ë¦½íŠ¸ë¡œ í…ŒìŠ¤íŠ¸

        - cURL + stdio ë˜í¼ (Node.js ì„œë²„ì¸ ê²½ìš°)
            * JSON-RPC ë©”ì‹œì§€ë¥¼ ì§ì ‘ stdinìœ¼ë¡œ ì „ì†¡
        - Postman/Thunder Client (HTTP transport ì‚¬ìš© ì‹œ)
            * REST APIì²˜ëŸ¼ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥


- ìƒ˜í”Œ ì†ŒìŠ¤
    * mcp clientì—ì„œ ì‹œì‘ mcp serverì„ ì‹œì‘ í›„ mcp clientë¥¼ êµ¬ë™í•œë‹¤.
    * ìƒ˜í”Œ ì†ŒìŠ¤ìƒì—ì„  lifespan ë‚´ë¶€ì—ì„œ ì„œë²„ ì‹¤í–‰ ì²˜ë¦¬ë¥¼ í•œë‹¤.
    ```py
    @asynccontextmanager
    async def lifespan(app: FastAPI):
        """FastAPI ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬"""
        # ì‹œì‘ ì‹œ
        try:
            print("ğŸ”„ MCP í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¤‘...")
            await mcp_client.connect()
        except Exception as e:
            print(f"âš ï¸ MCP ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {e}")
            print("âš ï¸ MCP ë„êµ¬ ì—†ì´ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤")
        
        yield
        
        # ì¢…ë£Œ ì‹œ
        try:
            await mcp_client.close()
            print("âœ… MCP í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")
        except Exception as e:
            print(f"âš ï¸ MCP í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: {e}")
    ```
    ```py
    async def connect(self):
        """MCP ì„œë²„ì— ì—°ê²° (stdio ë°©ì‹)"""
        try:
            print("ğŸ”„ MCP ì„œë²„ ì—°ê²° ì¤‘...")
            
            self.exit_stack = AsyncExitStack()
            
            server_params = StdioServerParameters(
                command="python",
                args=[MCP_SERVER_PATH]
            )
            
            # stdio í´ë¼ì´ì–¸íŠ¸ë¡œ MCP ì„œë²„ ì‹œì‘
            read, write = await self.exit_stack.enter_async_context(
                stdio_client(server_params)
            )
            
            # ì„¸ì…˜ ìƒì„± ë° ì´ˆê¸°í™”
            self.session = await self.exit_stack.enter_async_context(
                ClientSession(read, write)
            )
            
            await self.session.initialize()
            
            # ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            tools_result = await self.session.list_tools()
            self.available_tools = [
                {
                    "name": tool.name,
                    "description": tool.description,
                    "parameters": tool.inputSchema
                }
                for tool in tools_result.tools
            ]
            
            print(f"âœ… MCP ì„œë²„ ì—°ê²° ì„±ê³µ! ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬: {[t['name'] for t in self.available_tools]}")
            
        except Exception as e:
            print(f"âŒ MCP ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {e}")
            raise
    ```
    * MCP ì„œë²„ê°€ ë¶„ë¦¬ëœ ê²½ìš° SSE í˜•íƒœë¡œ ì—°ê²° ì‹œë„ë¥¼ í•œë‹¤.
    ```py
    # MCP ì„œë²„ ì„¤ì • ë³€ê²½
    MCP_SERVER_URL = "http://localhost:8001/sse"  # â† ê²½ë¡œ ë³€ê²½

    async def connect(self):
        """MCP ì„œë²„ì— ì—°ê²° (SSE ë°©ì‹)"""
        from mcp.client.sse import sse_client
        
        try:
            print(f"ğŸ”„ MCP ì„œë²„ ì—°ê²° ì¤‘... ({MCP_SERVER_URL})")
            
            self.exit_stack = AsyncExitStack()
            
            # SSE í´ë¼ì´ì–¸íŠ¸ë¡œ ì—°ê²° (ì„œë²„ëŠ” ì´ë¯¸ ì‹¤í–‰ ì¤‘)
            read, write = await self.exit_stack.enter_async_context(
                sse_client(MCP_SERVER_URL)  # â† URLë¡œ ì—°ê²°
            )        
    ```
    |êµ¬ë¶„|	í˜„ì¬ (ë‚´ì¥)|	ë¶„ë¦¬ (HTTP/SSE)|	ë¶„ë¦¬ (stdio)|
    |---|---|---|---|
    |ì„œë²„ ì‹œì‘|	í´ë¼ì´ì–¸íŠ¸ê°€ ì‹œì‘|	ë³„ë„ë¡œ ì´ë¯¸ ì‹¤í–‰ ì¤‘|	ë³„ë„ë¡œ ì‹¤í–‰|
    |í†µì‹  ë°©ì‹|	stdio (íŒŒì´í”„)|	HTTP/SSE|	stdio|
    |ì—°ê²° ëŒ€ìƒ|	ì„œë¸Œí”„ë¡œì„¸ìŠ¤|	ë„¤íŠ¸ì›Œí¬ URL|	í”„ë¡œì„¸ìŠ¤|
    |ì›ê²© ì—°ê²°|	âŒ|	âœ…|	âŒ|
    |ë¼ì´í”„ì‚¬ì´í´|	í´ë¼ì´ì–¸íŠ¸ê°€ ê´€ë¦¬|	ë…ë¦½ì |	ë…ë¦½ì |
    |í¬íŠ¸|	ì—†ìŒ|	8001 ë“±|	ì—†ìŒ|

    * chat
        - call_ollama ë¡œ LLM ì„œë²„ í˜¸ì¶œ
            * í…ìŠ¤íŠ¸ ìˆ˜ì‹  -> LLM í•¨ìˆ˜ êµ¬ë¶„ -> MCP í•¨ìˆ˜ ëª©ë¡ ë§¤ì¹­ -> í•¨ìˆ˜ ì‹¤í–‰
        - ollama API
        ```py
        async def call_ollama(prompt: str, model: str = OLLAMA_MODEL) -> str:
            """Ollama API í˜¸ì¶œ"""
            async with httpx.AsyncClient(timeout=120.0) as client:
                try:
                    # /api/generate ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                    response = await client.post(
                        f"{OLLAMA_BASE_URL}/api/generate",
                        json={
                            "model": model,
                            "prompt": prompt,
                            "stream": False
                        }
                    )
                    response.raise_for_status()
                    result = response.json()
                    return result.get("response", "")
                except httpx.HTTPError as e:
                    raise HTTPException(status_code=500, detail=f"Ollama í˜¸ì¶œ ì˜¤ë¥˜: {str(e)}")
        ```
        - parse_tool_calls
        ```py
        async def parse_tool_calls(llm_response: str) -> List[Dict[str, Any]]:
            """LLM ì‘ë‹µì—ì„œ ë„êµ¬ í˜¸ì¶œ íŒŒì‹±"""
            # ê°„ë‹¨í•œ íŒŒì‹± ë¡œì§ (ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ íŒŒì‹±ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ)
            tool_calls = []            
            # "use_tool: tool_name(arg1=value1, arg2=value2)" í˜•ì‹ì„ ì°¾ìŒ
            import re
            pattern = r'use_tool:\s*(\w+)\((.*?)\)'
            matches = re.finditer(pattern, llm_response)            
            for match in matches:
                tool_name = match.group(1)
                args_str = match.group(2)                
                # ì¸ì íŒŒì‹±
                args = {}
                if args_str.strip():
                    for arg in args_str.split(','):
                        if '=' in arg:
                            key, value = arg.split('=', 1)
                            key = key.strip()
                            value = value.strip().strip('"\'')
                            # íƒ€ì… ë³€í™˜ ì‹œë„
                            try:
                                value = int(value)
                            except ValueError:
                                try:
                                    value = float(value)
                                except ValueError:
                                    pass
                            args[key] = value                
                tool_calls.append({"name": tool_name, "arguments": args})            
            return tool_calls
        ```






