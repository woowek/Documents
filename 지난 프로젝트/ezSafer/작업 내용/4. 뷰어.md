>로직
---
1. 세션으로 권한정보 읽은 후 메뉴 노출 처리
2. 다운받은 문서정보 xml파일로 문서정보 조회 후 파일 다운로드
3. 다운받은 파일 pdf 변환
    - 이미지 : pdfbox로 서버 내부에서 변경
    - 기타 : ezRendition으로 soap 호출
4. 파일 워터마크 처리 후 파일 열기(pdf.js)



>>세션 처리
```java
HttpSession session = req.getSession();
session.setAttribute("docId", docId);
session.setAttribute("userId", userInfo.getUserId());
session.setAttribute("userName", userInfo.getUserName());
```

>>이미지 pdf 변경
* pdf작업은 pdfbox로 처리
* tiff의 경우 이미지 분할 후 재조합
* 일반 이미지
```java
InputStream inputStream = new FileInputStream(orgFile);
BufferedImage bufferedImage = ImageIO.read(inputStream);

//리사이징 처리
BufferedImage resizeBufferedImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
Graphics2D graphics2D = resizeBufferedImage.createGraphics();
graphics2D.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
graphics2D.drawImage(bufferedImage, 0, 0, width, height, null);
graphics2D.dispose();

// PDF 페이지 객체 1장 생성
PDPage page = new PDPage(new PDRectangle(width, height));
pdfDoc.addPage(page);

// PDF 문서 객체에 페이지 1장 그리기
PDImageXObject pdImage = LosslessFactory.createFromImage(pdfDoc, resizeBufferedImage);
PDPageContentStream contentStream = new PDPageContentStream(pdfDoc, page);
contentStream.drawImage(pdImage, 0, 0, width, height);

// 1장 그릴 때마다 사용한 객체 닫기
contentStream.close();
inputStream.close();
```

* tiff 이미지
    - tiff파일에서 이미지 정보 추출 후 pdf페이지에 그린다.
    - tiff이미지 추출은 JAI 사용
```java
SeekableStream seekableStream = new FileSeekableStream(orgFile);
ImageDecoder imageDecoder = ImageCodec.createImageDecoder("tiff", seekableStream, null);
RenderedImage renderedImage[];
renderedImage = new RenderedImage[imageDecoder.getNumPages()];
int count = 0;
for (int i = 0; i < imageDecoder.getNumPages(); i++) {
    renderedImage[i] = imageDecoder.decodeAsRenderedImage(i);
    count++;
}

String orgFileName_NoExt = orgFile.getName().substring(0, orgFile.getName().lastIndexOf("."));
for (int i = 0; i < count; i++) {
    ParameterBlock parameterBlock = new ParameterBlock();
    parameterBlock.addSource(imageDecoder.decodeAsRenderedImage(i));
    parameterBlock.add(orgFileName_NoExt + Integer.toString(i) + "." + orgExt);
    RenderedOp renderedOp = JAI.create("filestore", parameterBlock);
    BufferedImage bufferedImage = renderedOp.getAsBufferedImage();
    
    //리사이징 처리
    BufferedImage resizeBufferedImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
    Graphics2D graphics2D = resizeBufferedImage.createGraphics();
    graphics2D.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
    graphics2D.drawImage(bufferedImage, 0, 0, width, height, null);
    graphics2D.dispose();
    
    // PDF 페이지 객체 1장 생성
    PDPage page = new PDPage(new PDRectangle(width, height));
    pdfDoc.addPage(page);
    // PDF 문서 객체에 페이지 1장 그리기
    PDImageXObject pdImage = LosslessFactory.createFromImage(pdfDoc, resizeBufferedImage);
    PDPageContentStream contentStream = new PDPageContentStream(pdfDoc, page);
    contentStream.drawImage(pdImage, 0, 0, width, height);
    // 1장 그릴 때마다 사용한 객체 닫기
    contentStream.close();
}
```
>SOAP 호출
* .net로 구성한 웹서비스를 호출하여 return을 받는다.
* .net에서는 그냥 외부참조 추가하면 됐는데 자바는 아예 SOAP 규격에 맞는 XML을 만들어서 보내버린다...
```java
String requestXml = "<?xml version=\"1.0\" encoding=\"utf-8\"?>" + 
        "<soap:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\">" + 
        "  <soap:Body>" + 
        "    <함수명 xmlns=\"http://tempuri.org/\">" + 
        "      <파라미터1><![CDATA["+  + "]]></파라미터1>" +
        "      <파라미터2><![CDATA[" +  + "]]></파라미터2>" +
        "      <파라미터3><![CDATA[" +  + "]]></파라미터3>" +
        "    </함수명>" + 
        "  </soap:Body>" + 
        "</soap:Envelope>";
        
StringReader reader = new StringReader(requestXml);
InputSource is = new InputSource(reader);
Document document = parser.parse(is);
DOMSource requestSource = new DOMSource(document);

//SOAPMessage create
MessageFactory messageFactory = MessageFactory.newInstance();
SOAPMessage requestSoapMessage = messageFactory.createMessage(); 
SOAPPart requestSoapPart = requestSoapMessage.getSOAPPart(); 
requestSoapPart.setContent(requestSource);

//SOAPConnection create instance
SOAPConnectionFactory scf = SOAPConnectionFactory.newInstance();
SOAPConnection connection = scf.createConnection();

long startTime = System.currentTimeMillis();
//SOAP SEND MESSAGE
SOAPMessage responseSoapMessage = connection.call(requestSoapMessage, URL);
ByteArrayOutputStream out = new ByteArrayOutputStream();
responseSoapMessage.writeTo(out);

long endTime = System.currentTimeMillis();
long lTime = endTime - startTime;
log.debug("Rendition Conversion Time : " + (lTime/1000) % 60 + "(second)");

//SOAP Response
String rtn = new String(out.toByteArray(), "UTF-8");
StringReader resreader = new StringReader(rtn);
InputSource resis = new InputSource(resreader);
Document resdocument = parser.parse(resis);
NodeList list = resdocument.getElementsByTagName("ConvertImageResult");
Element row = (Element) list.item(0);
String rtnXML = row.getChildNodes().item(0).getNodeValue();
```
>다운로드 처리
* 클라이언트가 파일을 열던 파일을 다운로드하던 별도의 다운로드 처리가 필요하다.
```java
```